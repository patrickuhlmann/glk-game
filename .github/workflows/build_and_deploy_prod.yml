name: Build and deploy on Prod

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry Run'
        required: false
        default: false

jobs:
  build_and_test:
    name: "Build and Test"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2.4.0

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2.4.1
      with:
        node-version: 14.x

    - name: Get yarn cache directory path
      id: yarn-cache-dir-path
      run: echo "::set-output name=dir::$(yarn cache dir)"

    - uses: actions/cache@v2.1.6
      id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
      with:
        path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
        key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-yarn-

    - name: "Install Dependencies"
      run: yarn --frozen-lockfile

    - name: "Build"
      run: yarn run build

    - name: Archive dist
      uses: actions/upload-artifact@v2
      with:
        name: dist
        path: dist

    - name: Archive .htaccess
      uses: actions/upload-artifact@v2
      with:
        name: .htaccess
        path: .htaccess

    - name: "Unit Tests"
      run: yarn run test

    - name: Archive report
      uses: actions/upload-artifact@v2
      with:
        name: unit test coverage report
        path: coverage

    - name: generate build number
      id: build_number
      uses: zyborg/gh-action-buildnum@v1.2.0
      with:
        gist_token: ${{ secrets.GIST_TOKEN }}

  release:
    name: "Create a release"
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - name: get existing build number
        uses: zyborg/gh-action-buildnum@v1.2.0
        id: lastBuildNum
        with:
          gist_token: ${{ secrets.GIST_TOKEN }}
          skip_bump: true

      - name: Checkout
        uses: actions/checkout@v2.4.0

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v3.0.0
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1.1.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.lastBuildNum.outputs.global_build_number }}
          release_name: Release v${{ steps.lastBuildNum.outputs.global_build_number }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: Download dist
        uses: actions/download-artifact@v2
        with:
          name: dist
          path: dist

      - name: Zip dist
        run: |
          (cd dist && zip -r ../dist.zip .)

      - name: Download unit test report
        uses: actions/download-artifact@v2
        with:
          name: unit test coverage report
          path: coverage

      - name: Zip coverage report
        run: |
          (cd coverage && zip -r ../unit_test_coverage_report.zip .)

      - name: Upload Dist Archive
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist.zip
          asset_name: dist.zip
          asset_content_type: application/zip

      - name: Upload Unit Test Report
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./unit_test_coverage_report.zip
          asset_name: unit_test_coverage_report.zip
          asset_content_type: application/zip

  deploy:
    name: "Deploy to Cyon"
    needs: release
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: "https://glk.cevimail.ch/"
    steps:
      - name: Download dist
        uses: actions/download-artifact@v2
        with:
          name: dist

      - name: Download .htaccess
        uses: actions/download-artifact@v2
        with:
          name: .htaccess

      - name: FTP-Deploy-Action
        uses: SamKirkland/FTP-Deploy-Action@4.2.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          port: 21
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          local-dir: ./
          server-dir: ./
          dry-run: ${{ github.event.inputs.dry-run }}
          security: loose
